<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Backroom Bratzz Deluxe</title>
<style>
  :root{
    --bg:#080a12; --panel:#10162a; --panel-2:#151b34;
    --ink:#f8faff; --muted:#d0d7f5; --line:#45507a;
    --accent:#5ca3ff; --good:#62e075; --warn:#ffca38;
    --glass:rgba(8,10,18,.8); --powerup:#ff5c5c; --combo:#ffd700;
    --alex:#ff8c66; --riley:#b266ff; --danger:#ff3838; --manager:#a0a0a0;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:14px;padding:14px}
  header{width:100%;max-width:960px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{font-size:clamp(22px,4.5vw,30px);margin:6px 0;letter-spacing:.5px;text-shadow:0 2px 4px rgba(0,0,0,.5), 0 0 10px rgba(92,163,255,.3)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .btn{background:linear-gradient(180deg,var(--panel),#0c1226);color:var(--ink);
       border:1px solid var(--line);padding:.7rem 1rem;border-radius:14px;cursor:pointer;
       user-select:none;transition:.2s transform,.2s background,.2s box-shadow;display:inline-flex;align-items:center;gap:.6rem;
       box-shadow:0 2px 0 rgba(255,255,255,.06) inset, 0 8px 20px rgba(0,0,0,.35)}
  .btn:hover{background:linear-gradient(180deg,var(--panel-2),#0e1530);transform:scale(1.02)}
  .btn:active{transform:scale(.98)}
  .accent{border-color:var(--accent); box-shadow:0 0 0 2px rgba(92,163,255,.4), 0 10px 24px rgba(92,163,255,.1)}
  .good{border-color:var(--good)}
  .disabled{opacity:.6;pointer-events:none}
  #game{width:100%;max-width:960px;aspect-ratio:16/10;background:linear-gradient(180deg,#121a34,#0a1124);
        border:2px solid var(--line);border-radius:18px;position:relative;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,.5)}
  canvas{width:100%;height:100%;display:block;touch-action:none}
  .hud{position:absolute;inset:0;pointer-events:none; z-index:10;}
  #overlay{pointer-events:auto;}
  #overlay:empty{pointer-events:none;}
  .hud .top{position:absolute;left:12px;right:12px;top:12px;display:flex;justify-content:space-between;gap:12px;
            font-weight:700;font-size:clamp(13px,2.3vw,17px);text-shadow:0 1px 2px rgba(0,0,0,.6);flex-wrap:wrap}
  .pill{background:linear-gradient(180deg,rgba(20,26,42,.95),rgba(12,18,32,.95));border:1px solid var(--line);
        padding:.5rem .8rem;border-radius:999px;backdrop-filter:blur(8px);color:var(--ink);box-shadow:0 4px 12px rgba(0,0,0,.3)}
  .centerMsg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;text-align:center;padding:20px}
  .card{pointer-events:auto;background:linear-gradient(180deg,var(--panel-2),#0b1328);
        border:2px solid var(--line);border-radius:20px;padding:24px;max-width:min(620px,94%);
        box-shadow:0 16px 48px rgba(0,0,0,.5), 0 0 0 2px rgba(92,163,255,.15)}
  .card h2,.card h3{margin:0 0 10px;text-shadow:0 2px 2px rgba(0,0,0,.6)}
  .choose{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
  .charBtn{border:2px solid var(--accent);border-radius:16px;padding:12px;background:linear-gradient(135deg,#0c142a,#121a34);cursor:pointer;
           transition:.2s transform,.2s box-shadow,.2s border-color;color:var(--ink);box-shadow:0 0 10px rgba(92,163,255,.5), inset 0 0 5px rgba(92,163,255,.3);
           animation:shimmer 2s linear infinite alternate;}
  .charBtn:hover{transform:translateY(-3px);box-shadow:0 0 20px rgba(92,163,255,.7), inset 0 0 10px rgba(92,163,255,.5);border-color:#7bbfff}
  .kbd{padding:3px 7px;border:1px solid var(--line);border-radius:8px;background:#10162a;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
  .score-pop{position:absolute;font-size:16px;font-weight:700;color:var(--combo);animation:scorePop 1s ease-out forwards;text-shadow:0 2px 4px rgba(0,0,0,.5);pointer-events:none}
  @keyframes scorePop{0%{transform:translateY(0) scale(1);opacity:1} 50%{transform:translateY(-30px) scale(1.2)} 100%{transform:translateY(-50px) scale(1);opacity:0}}
  .warn-pop{position:absolute;font-size:24px;font-weight:700;color:var(--danger);animation:warnPop 1.5s ease-out forwards;text-shadow:0 2px 4px rgba(0,0,0,.5);pointer-events:none}
  @keyframes warnPop{
    0% {transform:translateY(0) scale(1);opacity:1}
    20% {transform:translateY(-10px) scale(1.8);color:#ffffff}
    40% {transform:translateY(-20px) scale(1.2)}
    60% {transform:translateY(-30px) scale(1.6);color:#ffffff}
    80% {transform:translateY(-40px) scale(1.3)}
    100% {transform:translateY(-60px) scale(1);opacity:0}
  }
  dialog{border:none;border-radius:16px;max-width:560px;width:clamp(280px,90vw,560px);background:linear-gradient(180deg,var(--panel-2),#0b1328);color:var(--ink);padding:0;box-shadow:0 16px 48px rgba(0,0,0,.6)}
  dialog::backdrop{background: rgba(0,0,0,.6)}
  .modal-head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line)}
  .modal-body{padding:18px;display:grid;gap:14px}
  .opt{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .opt label{opacity:.95}
  .opt input[type="range"]{width:180px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:linear-gradient(180deg,#141a2d,#0f1529);font-size:12px;color:var(--muted)}
  .hi-contrast :is(.pill,.btn){border-color:#fff}
  footer{opacity:.9;font-size:14px;color:var(--muted);text-shadow:0 1px 2px rgba(0,0,0,.5)}
  @keyframes shimmer {
    0% { box-shadow: 0 0 10px rgba(92,163,255,.5), inset 0 0 5px rgba(92,163,255,.3); }
    100% { box-shadow: 0 0 20px rgba(92,163,255,.8), inset 0 0 10px rgba(92,163,255,.6); }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>üü¶ Backroom Bratzz Deluxe</h1>
    <div class="row">
      <button id="btnStart" class="btn accent">Start</button>
      <button id="btnPause" class="btn">Pause</button>
      <button id="btnRestart" class="btn">Restart</button>
      <button id="btnFS" class="btn good" title="Fullscreen (F)">Fullscreen</button>
      <button id="btnSettings" class="btn">Settings</button>
      <button id="btnMute" class="btn">Mute</button>
    </div>
  </header>

  <div id="game">
    <canvas id="c"></canvas>
    <div class="hud">
      <div class="top">
        <div class="pill">Score: <span id="score">0</span></div>
        <div class="pill">Level: <span id="level">1</span></div>
        <div class="pill">Time: <span id="time">60.0</span>s</div>
        <div class="pill">Streak: <span id="streak">0</span></div>
        <div class="pill">Combo: <span id="combo">1x</span></div>
        <div class="pill">Warnings: <span id="warnings">0/3</span></div>
        <div class="pill">Pizza: <span id="pizza">0/3</span></div>
        <div class="pill">Power: <span id="power">None</span></div>
      </div>
      <div class="centerMsg" id="overlay"></div>
    </div>
  </div>

  <footer>
    Tap/click (or hold) to shoot blue rubber bands. Stars = bonuses. Avoid Rea-Rea (manager)‚Äî3 hits and you‚Äôre fired. Hit Jaxon (fast manager) 3 times to unlock Ninja (this session). Collect üçï pizzas (3) to trigger your character‚Äôs special: Alex = Rapid Fire, Riley-L = Spread Shot. Ninja shoots ninja-stars and pizza gives 10 points. Hotkeys: <span class="kbd">F</span> Fullscreen, <span class="kbd">Space</span> Shoot, <span class="kbd">P</span> Pause, <span class="kbd">R</span> Restart, <span class="kbd">,</span> Settings, <span class="kbd">M</span> Mute.
  </footer>
</div>

<dialog id="settingsDlg">
  <div class="modal-head">
    <h3 style="margin:0">Settings</h3>
    <button class="btn" id="closeSettings">Close</button>
  </div>
  <div class="modal-body">
    <div class="opt"><label for="autoFire">Auto-fire (hold Space/touch)</label><input id="autoFire" type="checkbox"/></div>
    <div class="opt"><label for="hitboxes">Show hitboxes (debug)</label><input id="hitboxes" type="checkbox"/></div>
    <div class="opt"><label for="hiContrast">High-contrast UI</label><input id="hiContrast" type="checkbox"/></div>
    <div class="opt"><label for="musicOn">Music on</label><input id="musicOn" type="checkbox"/></div>
    <div class="opt"><label for="sfxVol">SFX volume</label><input id="sfxVol" type="range" min="0" max="1" step="0.05"/></div>
    <div class="badge">Settings are saved automatically</div>
  </div>
</dialog>

<script>
(() => {
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const container = document.getElementById('game');
  const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  ['touchmove','dblclick'].forEach(ev=>document.addEventListener(ev, e=>e.preventDefault(), {passive:false}));

  function resize(){
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.round(rect.width * dpr);
    canvas.height= Math.round(rect.height* dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  new ResizeObserver(resize).observe(canvas); resize();

  // ==== Audio ====
  const audioCtx = (window.AudioContext ? new AudioContext() : null);
  let soundEnabled = true; // Mute button controls this (mutes ALL sound)
  ['pointerdown','touchstart','click'].forEach(ev =>
    window.addEventListener(ev, () => {
      if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    }, { once:true, passive:true })
  );

  // Overlay helper
  const overlay = document.getElementById('overlay');
  function setOverlay(html=""){ overlay.innerHTML = html; overlay.style.pointerEvents = html ? "auto" : "none"; }

  // UI refs
  const settingsDlg = document.getElementById('settingsDlg');
  const ui = {
    score: document.getElementById('score'),
    level: document.getElementById('level'),
    time: document.getElementById('time'),
    streak: document.getElementById('streak'),
    combo: document.getElementById('combo'),
    warnings: document.getElementById('warnings'),
    pizza: document.getElementById('pizza'),
    power: document.getElementById('power'),
    btnStart: document.getElementById('btnStart'),
    btnPause: document.getElementById('btnPause'),
    btnRestart: document.getElementById('btnRestart'),
    btnFS: document.getElementById('btnFS'),
    btnSettings: document.getElementById('btnSettings'),
    btnMute: document.getElementById('btnMute'),
    autoFire: document.getElementById('autoFire'),
    hitboxes: document.getElementById('hitboxes'),
    hiContrast: document.getElementById('hiContrast'),
    musicOn: document.getElementById('musicOn'),
    sfxVol: document.getElementById('sfxVol'),
    closeSettings: document.getElementById('closeSettings'),
  };

  const settings = {
    autoFire: JSON.parse(localStorage.getItem('bratzz_autoFire') || 'true'),
    hitboxes: JSON.parse(localStorage.getItem('bratzz_hitboxes') || 'false'),
    hiContrast: JSON.parse(localStorage.getItem('bratzz_hiContrast') || 'false'),
    musicOn: JSON.parse(localStorage.getItem('bratzz_musicOn') || 'false'), // default off
    sfxVol: parseFloat(localStorage.getItem('bratzz_sfxVol') || '0.8')
  };

  // World + state
  const W = 960, H = 600;
  const state = {
    running:false, paused:false, over:false,
    level:1,
    timeLeft:60, score:0, streak:0, bestStreak:0, combo:1,
    reaHits:0, player:null, shots:[], targets:[], particles:[], powerups:[], pizzas:[],
    lastSpawn:0, spawnEvery:[500,1000], lastTime:0, difficulty:1,
    lastPowerup:0, powerupEvery:[4500,9000], // Increased for less frequency
    lastManager:0, managerEvery:[8000,12000],
    lastPizza:0, pizzaEvery:[6000,10500], // Increased for less frequency
    doubleComboEnd:0,
    highScore: +localStorage.getItem('bratzzHighScore') || 0,
    highStreak: +localStorage.getItem('bratzzHighStreak') || 0,
    fireCooldownMs: 180, fireTimer: 0, autoFireDown:false,
    pizzaCount:0,
    power: {kind:'none', end:0},
    jaxonHits:0, jaxonDoubleEnd:0, jaxonDoubleSoundTimer:0,
    shield:0,
    ninjaUnlocked:false, // persists across restarts this page session
    musicOn: settings.musicOn
  };

  function applySettingsToUI(){
    ui.autoFire.checked = settings.autoFire;
    ui.hitboxes.checked = settings.hitboxes;
    ui.hiContrast.checked = settings.hiContrast;
    ui.musicOn.checked = settings.musicOn;
    ui.sfxVol.value = settings.sfxVol;
    document.body.classList.toggle('hi-contrast', settings.hiContrast);
  }
  applySettingsToUI();

  // Utils
  const rand=(a,b)=>a+Math.random()*(b-a);
  const randi=(a,b)=>a+Math.floor(Math.random()*(b-a+1));
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const lerp=(a,b,t)=>a+(b-a)*t;

  // Input (player is stationary gun; pointer aims)
  let pointer={x:W/2,y:H/2,down:false};
  canvas.addEventListener('pointermove',e=>{
    const r=canvas.getBoundingClientRect();
    pointer.x=clamp((e.clientX-r.left)/r.width*W,0,W);
    pointer.y=clamp((e.clientY-r.top)/r.height*H,0,H);
  });
  canvas.addEventListener('pointerdown',()=>{ pointer.down=true; state.autoFireDown=true; attemptShoot(); }, {passive:true});
  canvas.addEventListener('pointerup',()=>{ pointer.down=false; state.autoFireDown=false; }, {passive:true});
  window.addEventListener('blur', ()=>{ state.autoFireDown=false; pointer.down=false; });

  window.addEventListener('keydown',e=>{
    if(e.code==='Space'){ e.preventDefault(); state.autoFireDown = true; attemptShoot(); }
    else if(e.key==='p'||e.key==='P'){ togglePause(); }
    else if(e.key==='r'||e.key==='R'){ restart(); }
    else if(e.key==='f'||e.key==='F'){ toggleFullscreen(); }
    else if(e.key===','){ settingsDlg.open ? settingsDlg.close() : settingsDlg.showModal(); }
    else if(e.key==='m'||e.key==='M'){ ui.btnMute.click(); }
  });
  window.addEventListener('keyup',e=>{ if(e.code==='Space'){ state.autoFireDown = false; } });

  // Sound (SFX)
  function playSound(type='hit'){
    if(!audioCtx || !soundEnabled) return;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.connect(g); g.connect(audioCtx.destination);
    g.gain.value = 0.001;
    const now=audioCtx.currentTime, vol = Math.max(0.0001, settings.sfxVol);
    if(type==='hit'){
      o.type='triangle'; o.frequency.setValueAtTime(880, now); o.frequency.exponentialRampToValueAtTime(440, now+0.1);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.4*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.2);
    } else if(type==='miss'){
      o.type='square'; o.frequency.setValueAtTime(200, now); o.frequency.exponentialRampToValueAtTime(100, now+0.15);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.3*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.25);
    } else if(type==='powerup'){
      o.type='sine'; o.frequency.setValueAtTime(1100, now); o.frequency.exponentialRampToValueAtTime(1650, now+0.12);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.45*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.15);
    } else if(type==='shoot'){
      o.type='sawtooth'; o.frequency.setValueAtTime(660, now); o.frequency.exponentialRampToValueAtTime(330, now+0.06);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.25*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.1);
    } else if(type==='manager'){
      o.type='sawtooth'; o.frequency.setValueAtTime(150, now); o.frequency.exponentialRampToValueAtTime(75, now+0.25);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.6*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.3);
    } else if(type==='fired'){
      o.type='sawtooth'; o.frequency.setValueAtTime(250, now); o.frequency.exponentialRampToValueAtTime(60, now+0.6);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.6*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.7);
    } else if(type==='jaxonDouble'){
      o.type='sine'; o.frequency.setValueAtTime(1400, now); o.frequency.exponentialRampToValueAtTime(1800, now+0.1);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.35*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.15);
    } else if(type==='shield'){
      o.type='sine'; o.frequency.setValueAtTime(800, now); o.frequency.exponentialRampToValueAtTime(1200, now+0.15);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.5*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.2);
    } else if(type==='levelUp'){
      o.type='sine'; o.frequency.setValueAtTime(1000, now); o.frequency.exponentialRampToValueAtTime(2000, now+0.2);
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.5*vol, now+0.01); g.gain.exponentialRampToValueAtTime(0.001, now+0.3);
    }
    o.start(now); o.stop(now+0.7);
  }

  // Minimal music ping (muted by soundEnabled as well)
  const music = { enabled: settings.musicOn, bpm:112, barBeats:4, timer:null, master:null };
  function ensureMusicNodes() {
    if (!audioCtx) return;
    if (!music.master) {
      music.master = audioCtx.createGain();
      music.master.gain.value = 0.18;
      music.master.connect(audioCtx.destination);
    }
  }
  function scheduleBellHit(when = audioCtx.currentTime) {
    if (!audioCtx || !soundEnabled) return;
    const carrier = new OscillatorNode(audioCtx, { type: 'sine', frequency: 1200 });
    const carGain = new GainNode(audioCtx, { gain: 0.0001 });
    const mod = new OscillatorNode(audioCtx, { type: 'sine', frequency: 760 });
    const modGain = new GainNode(audioCtx, { gain: 900 });
    mod.connect(modGain).connect(carrier.frequency);
    const noise = audioCtx.createBufferSource();
    const buf = audioCtx.createBuffer(1, 4410, audioCtx.sampleRate);
    const ch = buf.getChannelData(0);
    for (let i = 0; i < ch.length; i++) ch[i] = (Math.random()*2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.03));
    noise.buffer = buf;
    const noiseGain = new GainNode(audioCtx, { gain: 0.15 });
    const delay = new DelayNode(audioCtx, { delayTime: 0.08 });
    const fb = new GainNode(audioCtx, { gain: 0.25 });
    delay.connect(fb).connect(delay);
    carrier.connect(carGain).connect(delay).connect(music.master);
    noise.connect(noiseGain).connect(music.master);
    const a = when, atk = 0.004, dec = 0.35;
    carGain.gain.setValueAtTime(0.0001, a);
    carGain.gain.exponentialRampToValueAtTime(0.70, a + atk);
    carGain.gain.exponentialRampToValueAtTime(0.0008, a + dec);
    modGain.gain.setValueAtTime(900, a);
    modGain.gain.exponentialRampToValueAtTime(40, a + 0.12);
    modGain.gain.exponentialRampToValueAtTime(5, a + 0.28);
    carrier.frequency.setValueAtTime(1200, a);
    carrier.frequency.exponentialRampToValueAtTime(980, a + 0.18);
    noiseGain.gain.setValueAtTime(0.15, a);
    noiseGain.gain.exponentialRampToValueAtTime(0.0001, a + 0.06);
    mod.start(a); carrier.start(a); noise.start(a);
    carrier.stop(a + 0.6); mod.stop(a + 0.6); noise.stop(a + 0.2);
  }
  function startMusic() {
    if (!audioCtx || !music.enabled || !soundEnabled) return;
    ensureMusicNodes();
    const beat = 60 / music.bpm;
    const bar  = beat * music.barBeats;
    function tick() {
      if (!music.enabled || !soundEnabled) return;
      const t0 = audioCtx.currentTime + 0.02;
      scheduleBellHit(t0);
      music.timer = setTimeout(tick, bar * 1000);
    }
    tick();
  }
  function stopMusic() { if (music.timer) { clearTimeout(music.timer); music.timer = null; } }
  // Spawning
  function spawnTarget(type='bald'){
    if (type === 'jaxon') {
      const speed = 600 * 0.75 * (1 + state.level * 0.1);
      const vx = randi(0, 1) ? speed : -speed;
      const x = vx > 0 ? -40 : W + 40;
      const y = 95;
      state.targets.push({x, y, w:40, h:40, vx, life:2000 / (1 + state.level * 0.2), t0:performance.now(), hit:false, type, hitCount:0});
    } else if (type === 'manager') {
      // Rea-Rea (pop-up like regular but penalizes on hit)
      const cols=9, lane=randi(0,cols-1), laneW=W/(cols+1);
      const x=(lane+1)*laneW, baseY=H*0.55, popH=rand(34,58);
      const life=rand(650,1200)/state.difficulty / (1 + state.level * 0.2);
      state.targets.push({x, y:baseY, targetY:baseY-popH, w:40, h:48, life, t0:performance.now(), hit:false, type:'manager', popT:0});
    } else {
      // Bald
      const cols=9, lane=randi(0,cols-1), laneW=W/(cols+1);
      const x=(lane+1)*laneW, baseY=H*0.55, popH=rand(34,58);
      const life=rand(650,1200)/state.difficulty / (1 + state.level * 0.2);
      state.targets.push({x, y:baseY, targetY:baseY-popH, w:40, h:48, life, t0:performance.now(), hit:false, type:'bald', popT:0});
    }
  }
  function spawnPowerup(){
    const cols=9, lane=randi(0,cols-1), laneW=W/(cols+1);
    const x=(lane+1)*laneW, baseY=H*0.55;
    const type=randi(0,3); // 0:+time,1:+score,2:double combo,3:shield
    const color = type===2 ? '#5ca3ff' : (type===3 ? '#00ff00' : '#ff5c5c');
    state.powerups.push({x, y:baseY-40, vy:50, size:22, life:1250, t0:performance.now(), collected:false, type, color}); // Shorter life, larger size, added vy for drift
  }
  function spawnPizza(){
    const cols=9, lane=randi(0,cols-1), laneW=W/(cols+1);
    const x=(lane+1)*laneW, baseY=H*0.55;
    state.pizzas.push({x, y:baseY-40, vy:50, size:24, life:2750, t0:performance.now(), collected:false}); // Shorter life, larger size, added vy for drift
  }

  // Shooting
  function attemptShoot(){
    if(!state.running||state.paused||state.over||!state.player) return;
    const now = performance.now();
    const cooldown = currentCooldown();
    if(now - state.fireTimer < cooldown) return;
    shootOnce(); state.fireTimer = now;
  }
  function currentCooldown(){
    if(state.player?.name === 'Ninja') return 70;
    if(state.power.kind === 'rapid') return 70;
    return 180;
  }
  function shootOnce(){
    playSound('shoot');
    const px=W/2, py=H*0.86, dx=pointer.x-px, dy=pointer.y-py, baseAngle=Math.atan2(dy,dx);
    const baseSpeed = 1050;
    const spreadActive = state.power.kind === 'spread' || state.player?.name === 'Ninja';
    const shots = spreadActive ? [{ang:baseAngle-0.12,r:6},{ang:baseAngle,r:6},{ang:baseAngle+0.12,r:6}]
                               : [{ang:baseAngle,r:5}];
    for(const s of shots){ state.shots.push({x:px,y:py,vx:Math.cos(s.ang)*baseSpeed,vy:Math.sin(s.ang)*baseSpeed,r:s.r,alive:true,age:0,ninjaStar:state.player?.name==='Ninja'}); }
    shake.start(4,60); if (navigator.vibrate) navigator.vibrate(10);
  }

  // Pizza flow
  function givePizza(){
    if(state.player?.name === 'Ninja') {
      state.score += 10;
      ui.score.textContent = state.score;
      showScorePopup(W*0.5, H*0.25, '+10');
      return;
    }
    state.pizzaCount = Math.min(3, state.pizzaCount+1);
    ui.pizza.textContent = `${state.pizzaCount}/3`;
    if(state.pizzaCount>=3){
      activateCharacterPower();
      state.pizzaCount = 0;
      ui.pizza.textContent = `0/3`;
    }
  }
  function activateCharacterPower(){
    const kind = (state.player?.name==='Alex') ? 'rapid' : 'spread';
    const duration = 9000 + state.level * 1000;
    state.power.kind = kind;
    state.power.end = performance.now() + duration;
    ui.power.textContent = `${kind==='rapid'?'Rapid Fire':'Spread'} ${(duration/1000).toFixed(1)}s`;
    showScorePopup(W*0.5, H*0.25, kind==='rapid' ? 'üçï Rapid Fire!' : 'üçï Spread Shot!');
  }
  function updatePowerTimer(){
    if(state.player?.name === 'Ninja') { ui.power.textContent = 'Ninja Mode'; return; }
    if(state.power.kind==='none'){ ui.power.textContent = 'None'; return; }
    const remain = Math.max(0, state.power.end - performance.now());
    if(remain<=0){
      state.power.kind='none'; state.power.end=0;
      ui.power.textContent='None';
    }else{
      ui.power.textContent = `${state.power.kind==='rapid'?'Rapid Fire':'Spread'} ${(remain/1000).toFixed(1)}s`;
    }
  }

  // Shake / particles
  const shake={mag:0,dur:0,t:0,start(m,d){this.mag=m;this.dur=d;this.t=0;},offset(){if(this.t>=this.dur)return{x:0,y:0};this.t+=dtms;const k=1-(this.t/this.dur);return{x:(Math.random()*2-1)*this.mag*k,y:(Math.random()*2-1)*this.mag*k};}};
  function burst(x,y,color,count=20,speed=300){
    for(let i=0;i<count;i++){ const a=rand(0,Math.PI*2), v=rand(speed*.5,speed); state.particles.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:rand(200,400),age:0,color,size:rand(2,5)}); }
    if(color === '#ffd700') for(let i=0;i<10;i++){ const a=rand(0,Math.PI*2), v=rand(100,200); state.particles.push({x,y,vx:Math.cos(a)*v,vy:Math.sin(a)*v,life:rand(300,500),age:0,color:'#ffffff',size:rand(1,3)}); }
  }
  function jaxonTrail(x,y,vx){
    const a = vx > 0 ? Math.PI : 0;
    for(let i=0;i<2;i++){
      const va = a + rand(-0.3,0.3), v=rand(50,100);
      state.particles.push({x,y,vx:Math.cos(va)*v,vy:Math.sin(va)*v,life:rand(100,200),age:0,color:'#ffd700',size:rand(1,3)});
    }
  }

  // Drawing
  function fillRectGrad(x,y,w,h,c1,c2){ const g=ctx.createLinearGradient(x,y,x,y+h); g.addColorStop(0,c1); g.addColorStop(1,c2); ctx.fillStyle=g; ctx.fillRect(x,y,w,h); }
  function drawBackground(){
    const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#161e3a'); g.addColorStop(1,'#0c142a');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    ctx.fillStyle='rgba(255,255,255,.03)'; ctx.fillRect(0,H*0.1,W,H*0.05); ctx.fillRect(0,H*0.3,W,H*0.03);
    ctx.fillStyle='rgba(0,0,0,.2)'; ctx.fillRect(W*0.05,H*0.7,W*0.1,H*0.2); ctx.fillRect(W*0.85,H*0.65,W*0.08,H*0.25);
    ctx.strokeStyle='rgba(92,163,255,.1)'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,H*0.8); ctx.lineTo(W,H*0.8); ctx.stroke();
    const cols=9, laneW=W/(cols+1), baseY=H*0.63;
    for(let c=0;c<cols;c++){ const x=(c+1)*laneW;
      for(let r=0;r<3;r++){ const bw=70, bh=50, bx=x-bw/2+(r===0?0:(r===1?5:-5)), by=baseY-r*(bh-6);
        fillRectGrad(bx,by,bw,bh,'#8a7848','#6a5a38'); ctx.strokeStyle='#4a3e24'; ctx.lineWidth=2; ctx.strokeRect(bx+.5,by+.5,bw-1,bh-1);
        ctx.fillStyle='#e6d598'; ctx.fillRect(bx+bw/2-6,by+2,12,bh-4); ctx.fillStyle='rgba(255,255,255,.08)'; ctx.fillRect(bx+1,by+1,bw-2,3);
      }
    }
    for(let i=0;i<8;i++){ const cx=(i+0.5)*W/9; ctx.fillStyle='rgba(255,255,255,.05)'; ctx.fillRect(cx-50,20,100,12); ctx.strokeStyle='rgba(92,163,255,.15)'; ctx.lineWidth=1; ctx.strokeRect(cx-50,20,100,12); }
  }
  function drawPlayer(){
    if(!state.player) return;
    const px=W/2, py=H*0.86;
    if(state.player.name==='Alex'){
      // head
      ctx.fillStyle='#f2d4c7'; ctx.beginPath(); ctx.ellipse(px,py-60,15,20,0,0,Math.PI*2); ctx.fill();
      // shirt
      const shirt=ctx.createLinearGradient(px-25,py-40,px-25,py+10); shirt.addColorStop(0,'#1c1c1c'); shirt.addColorStop(1,'#333333');
      ctx.fillStyle=shirt; ctx.beginPath(); ctx.moveTo(px-25,py-40); ctx.lineTo(px+25,py-40); ctx.quadraticCurveTo(px+20,py+10,px,py+10); ctx.quadraticCurveTo(px-20,py+10,px-25,py-40); ctx.fill();
      // legs
      const jeans=ctx.createLinearGradient(px-20,py+10,px-20,py+50); jeans.addColorStop(0,'#2a3a5a'); jeans.addColorStop(1,'#1e2a3f'); ctx.fillStyle=jeans; ctx.fillRect(px-20,py+10,40,40);
      // hair
      const hair=ctx.createLinearGradient(px-25,py-80,px+25,py+50); hair.addColorStop(0,'#3c2f2f'); hair.addColorStop(1,'#1f1515'); ctx.fillStyle=hair; ctx.fillRect(px-25,py-80,50,70);
    } else if(state.player.name==='Riley-L'){
      ctx.fillStyle='#f2d4c7'; ctx.beginPath(); ctx.ellipse(px,py-60,15,20,0,0,Math.PI*2); ctx.fill();
      const sweater=ctx.createLinearGradient(px-25,py-40,px-25,py+10); sweater.addColorStop(0,'#800000'); sweater.addColorStop(1,'#4c0000');
      ctx.fillStyle=sweater; ctx.beginPath(); ctx.moveTo(px-25,py-40); ctx.lineTo(px+25,py-40); ctx.quadraticCurveTo(px+20,py+10,px,py+10); ctx.quadraticCurveTo(px-20,py+10,px-25,py-40); ctx.fill();
      const pants=ctx.createLinearGradient(px-20,py+10,px-20,py+50); pants.addColorStop(0,'#1c1c1c'); pants.addColorStop(1,'#333333'); ctx.fillStyle=pants; ctx.fillRect(px-20,py+10,40,40);
      const hair=ctx.createLinearGradient(px-40,py-80,px+40,py-20); hair.addColorStop(0,'#3b1e4a'); hair.addColorStop(1,'#2a1436');
      ctx.fillStyle=hair; for(let i=0;i<12;i++){ const off=i%2?6:-6; ctx.beginPath(); ctx.arc(px-36+i*6,py-50+off,14,0,Math.PI*2); ctx.fill(); }
      ctx.fillStyle='#ffca38'; ctx.beginPath(); ctx.arc(px+20,py-70,6,0,Math.PI*2); ctx.fill();
    } else if(state.player.name==='Ninja'){
      ctx.fillStyle='#1c1c1c'; ctx.beginPath(); ctx.ellipse(px,py-60,15,20,0,0,Math.PI*2); ctx.fill();
      const suit=ctx.createLinearGradient(px-25,py-40,px-25,py+10); suit.addColorStop(0,'#1c1c1c'); suit.addColorStop(1,'#333333');
      ctx.fillStyle=suit; ctx.beginPath(); ctx.moveTo(px-25,py-40); ctx.lineTo(px+25,py-40); ctx.quadraticCurveTo(px+20,py+10,px,py+10); ctx.quadraticCurveTo(px-20,py+10,px-25,py-40); ctx.fill();
      ctx.fillStyle='#1c1c1c'; ctx.fillRect(px-20,py+10,40,40);
      const hood=ctx.createLinearGradient(px-25,py-80,px+25,py-20); hood.addColorStop(0,'#1c1c1c'); hood.addColorStop(1,'#333333');
      ctx.fillStyle=hood; ctx.fillRect(px-25,py-80,50,60);
    }
    // launcher line
    ctx.fillStyle = state.player.name==='Alex' ? '#5ca3ff' : (state.player.name==='Riley-L' ? '#b266ff' : '#1c1c1c');
    ctx.fillRect(px-14,py-16,28,12);
    ctx.fillStyle='rgba(255,255,255,.2)'; ctx.fillRect(px-14,py-16,28,3);
    ctx.strokeStyle='rgba(92,163,255,.5)'; ctx.lineWidth=2.5; ctx.beginPath(); ctx.moveTo(px,py-10); ctx.lineTo(pointer.x,pointer.y); ctx.stroke();

    // shield ring
    if (state.shield > 0) {
      const shieldAlpha = (state.shield * 0.5) / 3;
      ctx.strokeStyle = `rgba(0, 255, 0, ${shieldAlpha})`;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(px, py, 50, 0, Math.PI * 2);
      ctx.stroke();
    }
  }
  function drawTarget(t){
    if(t.type==='jaxon'){
      const x=t.x, y=t.y;
      const glow=ctx.createRadialGradient(x,y,0,x,y,50); glow.addColorStop(0,'rgba(255,215,0,0.3)'); glow.addColorStop(1,'rgba(255,215,0,0)');
      ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(x,y,50,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#f2d4c7'; ctx.fillRect(x-20,y-20,40,40);
      ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=1; ctx.strokeRect(x-20,y-20,40,40);
      const hair=ctx.createLinearGradient(x-25,y-30,x+25,y-10); hair.addColorStop(0,'#3c2f2f'); hair.addColorStop(1,'#1f1515'); ctx.fillStyle=hair; ctx.fillRect(x-25,y-30,50,20);
      ctx.fillStyle='#1a1a1a'; ctx.beginPath(); ctx.arc(x-8,y-5,3,0,Math.PI*2); ctx.arc(x+8,y-5,3,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#2a2a2a'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x-8,y+10); ctx.lineTo(x+8,y+10); ctx.stroke();
    } else {
      const prog=Math.min(1,t.popT/200); t.y=lerp(t.y,t.targetY,prog);
      const x=t.x, y=t.y;
      fillRectGrad(x-40,y+24,80,12,'#6a5a38','#4c3e27');
      ctx.fillStyle='#f2d4c7'; ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.lineWidth=1; ctx.stroke();
      if(t.type==='bald'){
        ctx.fillStyle='rgba(255,255,255,.2)'; ctx.beginPath(); ctx.arc(x-5,y-10,9,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='#1a1a1a'; ctx.beginPath(); ctx.arc(x-7,y-3,3,0,Math.PI*2); ctx.arc(x+7,y-3,3,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle='#b0b8c0'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(x-6,y+10); ctx.lineTo(x,y+16); ctx.lineTo(x+6,y+10); ctx.stroke();
        ctx.strokeStyle='#2a2a2a'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x-10,y-9); ctx.lineTo(x-3,y-11); ctx.moveTo(x+10,y-9); ctx.lineTo(x+3,y-11); ctx.stroke();
      } else if(t.type==='manager'){
        const hg=ctx.createLinearGradient(x-25,y-30,x+25,y-10); hg.addColorStop(0,'#a0a0a0'); hg.addColorStop(1,'#808080');
        ctx.fillStyle=hg; ctx.beginPath(); ctx.moveTo(x-22,y-25); ctx.quadraticCurveTo(x,y-35,x+22,y-25); ctx.lineTo(x+22,y-5); ctx.quadraticCurveTo(x,y-15,x-22,y-5); ctx.closePath(); ctx.fill();
        ctx.strokeStyle='#2a2a2a'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(x-8,y-3,5,0,Math.PI*2); ctx.arc(x+8,y-3,5,0,Math.PI*2); ctx.moveTo(x-13,y-3); ctx.lineTo(x-3,y-3); ctx.moveTo(x+3,y-3); ctx.lineTo(x+13,y-3); ctx.stroke();
        ctx.fillStyle='#1a1a1a'; ctx.beginPath(); ctx.arc(x-8,y-3,2,0,Math.PI*2); ctx.arc(x+8,y-3,2,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle='#2a2a2a'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(x-8,y+10); ctx.lineTo(x+8,y+10); ctx.stroke();
      }
    }
  }
  function drawShot(s){
    if(s.ninjaStar){
      const x=s.x, y=s.y, size=8;
      ctx.save(); ctx.translate(x,y); ctx.rotate(s.age/100);
      const g=ctx.createRadialGradient(0,0,0,0,0,size); g.addColorStop(0,'#5ca3ff'); g.addColorStop(1,'rgba(92,163,255,.1)');
      ctx.fillStyle=g; ctx.beginPath(); for(let i=0;i<4;i++){ const a=i*Math.PI*2/4; ctx.lineTo(Math.cos(a)*size,Math.sin(a)*size); ctx.lineTo(Math.cos(a+Math.PI/4)*size*0.5,Math.sin(a+Math.PI/4)*size*0.5); } ctx.closePath(); ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.lineWidth=1.5; ctx.stroke(); ctx.restore();
    } else {
      const grad=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,10); grad.addColorStop(0,'#5ca3ff'); grad.addColorStop(1,'rgba(92,163,255,.2)');
      ctx.strokeStyle=grad; ctx.lineWidth=4; ctx.beginPath(); ctx.ellipse(s.x,s.y,9,5,0,0,Math.PI*2); ctx.stroke();
      ctx.fillStyle='rgba(92,163,255,.35)'; ctx.beginPath(); ctx.ellipse(s.x,s.y,7,4,0,0,Math.PI*2); ctx.fill();
    }
  }
  function drawPowerupStar(p){
    const x=p.x, y=p.y, s=p.size;
    ctx.save(); ctx.translate(x,y); ctx.rotate((performance.now()-p.t0)/500);
    const g=ctx.createRadialGradient(0,0,0,0,0,s); g.addColorStop(0,p.color); g.addColorStop(1,'rgba(255,255,255,.1)');
    ctx.fillStyle=g; ctx.beginPath(); for(let i=0;i<5;i++){ const a=i*Math.PI*2/5; ctx.lineTo(Math.cos(a)*s,Math.sin(a)*s); ctx.lineTo(Math.cos(a+Math.PI/5)*s*0.5,Math.sin(a+Math.PI/5)*s*0.5); } ctx.closePath(); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.6)'; ctx.lineWidth=1.5; ctx.stroke(); ctx.restore();
  }
  function drawPizza(p){
    const x=p.x, y=p.y, s=p.size;
    ctx.save(); ctx.translate(x,y); ctx.rotate((performance.now()-p.t0)/800);
    ctx.fillStyle='#c68642'; ctx.beginPath(); ctx.arc(0,0,s,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#f6d56b'; ctx.beginPath(); ctx.arc(0,0,s*0.82,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#b54a3a';
    for (let i=0;i<6;i++){ const a=i*Math.PI/3; ctx.beginPath(); ctx.arc(Math.cos(a)*s*0.45,Math.sin(a)*s*0.45,s*0.18,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }
  function drawParticle(p){ ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); }

  // Popups
  function showScorePopup(x,y,text){
    const div = document.createElement('div'); div.className='score-pop'; div.textContent=text;
    // position relative to canvas
    const rect = canvas.getBoundingClientRect();
    const px = rect.left + (x/W)*rect.width, py = rect.top + (y/H)*rect.height;
    div.style.left = px+'px'; div.style.top = py+'px'; div.style.position='fixed';
    document.body.appendChild(div); setTimeout(()=>div.remove(),1000);
  }
  function showWarnPopup(x,y){
    const div = document.createElement('div'); div.className='warn-pop'; div.textContent='‚ö†';
    const rect = canvas.getBoundingClientRect();
    const px = rect.left + (x/W)*rect.width, py = rect.top + (y/H)*rect.height;
    div.style.left = (px-12)+'px'; div.style.top = (py-12)+'px'; div.style.position='fixed';
    document.body.appendChild(div); setTimeout(()=>div.remove(),1500);
  }

  // Helpers: collisions
  function hitTestShotVsTarget(s,t){ const dx=s.x-t.x, dy=s.y-t.y; const r = (t.w? t.w/2 : 20) + s.r; return dx*dx+dy*dy <= r*r; }
  function shotHitsPickup(s, p){
    const dx = s.x - p.x, dy = s.y - p.y;
    const rr = (s.r + p.size) * (s.r + p.size);
    return dx*dx + dy*dy <= rr;
  }

  // UI buttons
  function toggleFullscreen(){ if(!document.fullscreenElement){ container.requestFullscreen(); } else { document.exitFullscreen(); } }
  function togglePause(){
    if(!state.running||state.over) return;
    state.paused = !state.paused;
    ui.btnPause.textContent = state.paused ? 'Resume' : 'Pause';
    if(!state.paused){ state.lastTime=performance.now(); requestAnimationFrame(update); if(state.musicOn) startMusic(); }
    else { stopMusic(); }
  }
  function showTitle(){
    setOverlay(`
      <div class="card" style="text-align:center">
        <h2>Backroom Bratzz Deluxe</h2>
        <div>High Score: <strong>${state.highScore}</strong> ‚Ä¢ High Streak: <strong>${state.highStreak}</strong></div>
        <div class="choose" style="margin-top:12px">
          <button class="charBtn" data-name="Alex"><div class="mini"></div><h3>Alex</h3><p>Rapid Fire</p></button>
          <button class="charBtn" data-name="Riley-L"><div class="mini"></div><h3>Riley-L</h3><p>Spread Shot</p></button>
          ${state.ninjaUnlocked ? `<button class="charBtn" data-name="Ninja"><div class="mini"></div><h3>Ninja</h3><p>Ninja Stars</p></button>` : ``}
        </div>
        <div style="opacity:.95;margin-top:10px">Tap a character, then press <em>Start</em> or click the arena.</div>
      </div>`);
    // attach listeners AFTER overlay exists
    overlay.querySelectorAll('.charBtn').forEach(btn =>
      btn.addEventListener('click', () => choosePlayer(btn.dataset.name))
    );
  }
  function choosePlayer(name){
    state.player = {name};
    ui.btnStart.classList.remove('disabled');
    setOverlay(`
      <div class="card" style="text-align:center">
        <div style="font-size:18px;margin-bottom:10px">You chose <strong>${name}</strong></div>
        <button class="btn accent" id="go">Start Game</button>
      </div>`);
    overlay.querySelector('#go').addEventListener('click', start);
  }

  function restart(){
    stopMusic();
    state.running=false; state.paused=false; state.over=false;
    state.level=1; state.timeLeft=60; state.score=0; state.streak=0; state.bestStreak=0; state.combo=1;
    state.reaHits=0; state.shots=[]; state.targets=[]; state.particles=[]; state.powerups=[]; state.pizzas=[];
    state.lastSpawn=0; state.spawnEvery=[500,1000]; state.lastTime=0; state.difficulty=1;
    state.lastPowerup=0; state.powerupEvery=[4500,9000];
    state.lastManager=0; state.managerEvery=[8000,12000];
    state.lastPizza=0; state.pizzaEvery=[6000,10500];
    state.doubleComboEnd=0; state.pizzaCount=0; state.shield=0;
    state.jaxonDoubleEnd=0; state.jaxonDoubleSoundTimer=0;
    // keep ninjaUnlocked across restarts in this session
    state.power.kind='none'; state.power.end=0;
    // DO NOT force player to Ninja: only Ninja if user selects it
    // keep previous character selection? We‚Äôll require reselect:
    state.player=null;

    ui.score.textContent=state.score; ui.level.textContent=state.level; ui.time.textContent=state.timeLeft.toFixed(1);
    ui.streak.textContent=state.streak; ui.combo.textContent=`${state.combo}x`; ui.warnings.textContent=`${state.reaHits}/3`;
    ui.pizza.textContent=`${state.pizzaCount}/3`; ui.power.textContent='None';
    ui.btnPause.textContent='Pause';
    showTitle();
  }

  function start(){
    if(!state.player){ showTitle(); return; }
    state.running=true; state.paused=false; state.over=false;
    state.timeLeft = 60;
    state.lastTime=performance.now();
    setOverlay('');
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    if (state.musicOn) startMusic();
    requestAnimationFrame(update);
  }
  // Main loop
  let dtms=0;
  function update(){
    if(!state.running || state.paused || state.over) return;
    const now = performance.now();
    dtms = Math.min(33, now - state.lastTime); state.lastTime = now;

    // timers & difficulty
    state.timeLeft = Math.max(0, state.timeLeft - dtms/1000);
    const nextLevelScore = state.level * 1000;
    if(state.score >= nextLevelScore && state.level < 10){
      state.level++;
      state.difficulty *= 1.2;
      state.timeLeft += 10;
      playSound('levelUp');
      showScorePopup(W*0.5, H*0.25, `Level ${state.level}!`);
      ui.level.textContent = state.level;
    }

    // Spawns (no extra random gates; timings already randomized)
    if(now - state.lastSpawn > rand(state.spawnEvery[0],state.spawnEvery[1])/state.difficulty){
      spawnTarget(randi(0,9)<8?'bald':'manager');
      state.lastSpawn = now;
    }
    if(now - state.lastManager > rand(state.managerEvery[0],state.managerEvery[1])/state.difficulty){
      spawnTarget('jaxon');
      state.lastManager = now;
    }
    if(now - state.lastPowerup > rand(state.powerupEvery[0],state.powerupEvery[1])/state.difficulty){
      spawnPowerup();
      state.lastPowerup = now;
    }
    if(now - state.lastPizza > rand(state.pizzaEvery[0],state.pizzaEvery[1])/state.difficulty){
      spawnPizza();
      state.lastPizza = now;
    }

    // Auto-fire
    if(settings.autoFire && state.autoFireDown){ attemptShoot(); }

    // Shots
    for(let i=state.shots.length-1;i>=0;i--){
      const s=state.shots[i]; s.x+=s.vx*dtms/1000; s.y+=s.vy*dtms/1000; s.age+=dtms;
      if(s.x< -20||s.x>W+20||s.y< -20||s.y>H+20||s.age>2000){ state.shots.splice(i,1); continue; }
    }

    // Targets (movement + aging)
    for(let i=state.targets.length-1;i>=0;i--){
      const t=state.targets[i];
      if(t.type==='jaxon'){
        t.x += t.vx * dtms/1000; t.life -= dtms;
        jaxonTrail(t.x, t.y, t.vx);
        if(t.x<-40||t.x>W+40 || t.life<=0){ state.targets.splice(i,1); }
      } else {
        t.life -= dtms; t.popT += dtms;
        if(t.life<=0){ state.targets.splice(i,1); }
      }
    }

    // Powerups movement and aging
    for(let i=state.powerups.length-1;i>=0;i--){
      const p = state.powerups[i];
      p.y += p.vy * dtms / 1000; // Added drift
      if(now - p.t0 > p.life){ state.powerups.splice(i,1); continue; }
    }

    // Pizzas movement and aging
    for(let i=state.pizzas.length-1;i>=0;i--){
      const z = state.pizzas[i];
      z.y += z.vy * dtms / 1000; // Added drift
      if(now - z.t0 > z.life){ state.pizzas.splice(i,1); continue; }
    }

    // Shot collisions vs targets + pickups (shoot-to-collect)
    for(let j=state.shots.length-1;j>=0;j--){
      const s = state.shots[j];
      let used = false;

      // A) vs targets
      for(let i=state.targets.length-1;i>=0 && !used;i--){
        const t = state.targets[i];
        if(hitTestShotVsTarget(s,t)){
          // consume shot
          state.shots.splice(j,1); used = true;

          if(t.type==='bald'){
            const mult = (now < state.doubleComboEnd ? 2 : 1) * (now < state.jaxonDoubleEnd ? 2 : 1);
            const points = Math.floor(1 * state.combo * mult);
            state.score += points;
            state.streak++; state.bestStreak=Math.max(state.bestStreak,state.streak);
            state.combo = Math.min(5, state.combo + 0.25);
            ui.score.textContent=state.score; ui.streak.textContent=state.streak; ui.combo.textContent=`${state.combo.toFixed(2)}x`;
            burst(t.x,t.y,'#5ca3ff', 16); showScorePopup(t.x, t.y-20, `+${points}`); playSound('hit');
            state.targets.splice(i,1);
          } else if(t.type==='manager'){
            // shield first
            if(state.shield > 0){
              state.shield--;
              showWarnPopup(t.x, t.y);
              playSound('shield');
              state.targets.splice(i,1);
            } else {
              state.reaHits++; ui.warnings.textContent=`${state.reaHits}/3`;
              burst(t.x,t.y,'#ff3838', 24, 350); showWarnPopup(t.x, t.y); playSound('manager');
              state.targets.splice(i,1);
              if (state.reaHits >= 3) {
                state.over=true; state.running=false; playSound('fired');
                stopMusic();
                const bestScore = Math.max(state.highScore, state.score);
                if (state.score > state.highScore) localStorage.setItem('bratzzHighScore', state.score);
                if (state.bestStreak > state.highStreak) localStorage.setItem('bratzzHighStreak', state.bestStreak);
                setOverlay(`<div class="card" style="text-align:center">
                  <h3>You're Fired!</h3>
                  <div style="margin-bottom:10px">Score: <strong>${state.score}</strong> ‚Ä¢ Best Streak: <strong>${state.bestStreak}</strong> ‚Ä¢ High Score: <strong>${bestScore}</strong></div>
                  <div class="row" style="justify-content:center;margin-top:8px">
                    <button class="btn accent" id="again">Play Again</button>
                  </div>
                </div>`);
                overlay.querySelector('#again').addEventListener('click', restart);
              }
            }
          } else if(t.type==='jaxon'){
            t.hitCount++; playSound('hit');
            burst(t.x,t.y,'#ffd700', 16, 300); showScorePopup(t.x, t.y-20, `Jaxon ${t.hitCount}/3`);
            if(t.hitCount>=3){
              // unlock ninja for remainder of session
              state.ninjaUnlocked = true;
              state.jaxonDoubleEnd = now + 5000;
              showScorePopup(W*0.5, H*0.25, 'Jaxon Bonus: 2x!');
              state.targets.splice(i,1);
            }
          }
        }
      }

      // B) vs stars (powerups)
      for (let k=state.powerups.length-1;k>=0 && !used;k--){
        const p = state.powerups[k];
        if(p.collected || now - p.t0 > p.life) continue;
        if(shotHitsPickup(s,p)){
          p.collected = true;
          state.powerups.splice(k,1);
          state.shots.splice(j,1); used = true;

          if (p.type === 0) { state.timeLeft += 5; showScorePopup(p.x, p.y, '+5s'); }
          else if (p.type === 1) { state.score += Math.round(10*state.combo * (now < state.jaxonDoubleEnd ? 2 : 1)); ui.score.textContent=state.score; showScorePopup(p.x, p.y, '+10'); }
          else if (p.type === 2) { state.doubleComboEnd = now + 5000; showScorePopup(p.x, p.y, 'Double Combo!'); }
          else if (p.type === 3) { state.shield = 3; showScorePopup(p.x, p.y, 'Shield 3x!'); playSound('shield'); }
          burst(p.x,p.y,p.color || '#5ca3ff', 20, 300); playSound('powerup');
        }
      }

      // C) vs pizzas
      for (let k=state.pizzas.length-1;k>=0 && !used;k--){
        const z = state.pizzas[k];
        if(z.collected || now - z.t0 > z.life) continue;
        if(shotHitsPickup(s,z)){
          z.collected = true;
          state.pizzas.splice(k,1);
          state.shots.splice(j,1); used = true;

          if (state.player?.name === 'Ninja') {
            state.score += 10; ui.score.textContent = state.score; showScorePopup(z.x, z.y, '+10');
          } else {
            givePizza(); showScorePopup(z.x, z.y, '+üçï');
          }
          burst(z.x,z.y,'#ffca38', 20, 300); playSound('powerup');
        }
      }
    }

    // Miss penalty (reset streak/combo if a bald times out)
    // Already handled by life expiry ‚Üí no direct penalty here beyond progress loss

    // Particles
    for(let i=state.particles.length-1;i>=0;i--){
      const p=state.particles[i]; p.x+=p.vx*dtms/1000; p.y+=p.vy*dtms/1000; p.age+=dtms;
      if(p.age>=p.life) state.particles.splice(i,1);
    }

    // Combo timers
    if(state.doubleComboEnd>0 && now>state.doubleComboEnd){ state.combo=1; state.doubleComboEnd=0; ui.combo.textContent='1x'; }
    if(state.jaxonDoubleEnd>0 && now>state.jaxonDoubleEnd){ state.jaxonDoubleEnd=0; if(state.combo>1){ state.combo=1; ui.combo.textContent='1x'; } }
    if(state.jaxonDoubleEnd>0 && now-state.jaxonDoubleSoundTimer>1000){ playSound('jaxonDouble'); state.jaxonDoubleSoundTimer=now; }

    // Power timer
    updatePowerTimer();

    // Render
    const off = shake.offset();
    ctx.save(); ctx.translate(off.x, off.y);
    drawBackground();
    state.powerups.forEach(drawPowerupStar);
    state.pizzas.forEach(drawPizza);
    state.targets.forEach(drawTarget);
    state.shots.forEach(drawShot);
    drawPlayer();
    ctx.restore();

    ui.time.textContent = state.timeLeft.toFixed(1);
    if(state.timeLeft<=0){
      state.over=true; state.running=false;
      stopMusic();
      const bestScore = Math.max(state.highScore, state.score);
      if (state.score > state.highScore) localStorage.setItem('bratzzHighScore', state.score);
      if (state.bestStreak > state.highStreak) localStorage.setItem('bratzzHighStreak', state.bestStreak);
      setOverlay(`<div class="card" style="text-align:center">
        <h3>Time's Up!</h3>
        <div style="margin-bottom:10px">Score: <strong>${state.score}</strong> ‚Ä¢ Best Streak: <strong>${state.bestStreak}</strong> ‚Ä¢ High Score: <strong>${bestScore}</strong></div>
        <div class="row" style="justify-content:center;margin-top:8px"><button class="btn accent" id="again">Play Again</button></div>
      </div>`);
      overlay.querySelector('#again').addEventListener('click', restart);
    } else {
      requestAnimationFrame(update);
    }
  }

  // UI listeners
  ui.btnStart.addEventListener('click', start);
  ui.btnPause.addEventListener('click', togglePause);
  ui.btnRestart.addEventListener('click', restart);
  ui.btnFS.addEventListener('click', toggleFullscreen);
  ui.btnSettings.addEventListener('click', () => settingsDlg.showModal());
  ui.closeSettings.addEventListener('click', () => settingsDlg.close());

  ui.btnMute.addEventListener('click', () => {
    soundEnabled = !soundEnabled; // mute ALL sounds
    ui.btnMute.textContent = soundEnabled ? 'Mute' : 'Unmute';
    if (!soundEnabled) stopMusic(); else if (state.musicOn) startMusic();
  });

  ui.autoFire.addEventListener('change', e => { settings.autoFire = e.target.checked; localStorage.setItem('bratzz_autoFire', settings.autoFire); });
  ui.hitboxes.addEventListener('change', e => { settings.hitboxes = e.target.checked; localStorage.setItem('bratzz_hitboxes', settings.hitboxes); });
  ui.hiContrast.addEventListener('change', e => { settings.hiContrast = e.target.checked; localStorage.setItem('bratzz_hiContrast', settings.hiContrast); document.body.classList.toggle('hi-contrast', settings.hiContrast); });
  ui.musicOn.addEventListener('change', e => {
    settings.musicOn = e.target.checked; localStorage.setItem('bratzz_musicOn', settings.musicOn);
    state.musicOn = settings.musicOn;
    if(!state.musicOn) stopMusic(); else if(soundEnabled && state.running) startMusic();
  });
  ui.sfxVol.addEventListener('input', e => { settings.sfxVol = parseFloat(e.target.value); localStorage.setItem('bratzz_sfxVol', settings.sfxVol); });

  // Start screen & quick click-to-start
  function bootTitle(){
    ui.btnStart.classList.add('disabled');
    showTitle();
  }
  bootTitle();
  document.getElementById('game').addEventListener('click', ()=>{
    if(!state.running && !state.paused && !state.over){
      if(!state.player){ showTitle(); return; }
      start();
    }
  });
})();</script>
</body>
</html>
